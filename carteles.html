<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Cartells i protocols ‚Äì Hospital</title>
  <meta name="description" content="Selecci√≥ visual de cartells i protocols per servei i tipus. Carrusel t√†ctil i responsive."/>

  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://unpkg.com/swiper@11/swiper-bundle.min.css"/>

  <style>
    :root{ --text:#e8edf3; --muted:#9aa3ad; --accent:#4f8cff; --tap-min:44px }

    html, body { height:100%; }
    body { margin:0 !important; background:#0b1220; color:var(--text); opacity:0; transition:opacity .2s ease; }
    body.ready { opacity:1 } body.fading{ opacity:0 }

    .app{ position:fixed; inset:0; display:flex; flex-direction:column; min-height:100svh; height:100dvh; max-width:100vw; overflow:hidden; }

    /* HEADER */
    header.header{
      flex:0 0 auto;
      display:grid; grid-template-columns:1fr auto 1fr;
      align-items:center; gap:10px;
      padding:8px clamp(10px,2vw,16px);
      background:rgba(0,0,0,.25);
      border-bottom:1px solid rgba(255,255,255,.06);
      backdrop-filter: blur(4px);
    }
    .hdr-left{ justify-self:start }
    .hdr-center{ justify-self:center; display:flex; align-items:center; gap:10px; flex-wrap:wrap }
    .hdr-right{ justify-self:end; display:flex; gap:8px }
    .hdr-left h1{ margin:0; color:var(--text); font-size:clamp(16px, 2.6vw, 22px) }

    .service-select, .type-select, .search-input{
      background:rgba(255,255,255,.08);
      color:var(--text);
      border:1px solid rgba(255,255,255,.25);
      border-radius:12px;
      padding:8px 12px;
      min-height:var(--tap-min);
      font-weight:700;
      font-size:clamp(14px,1.6vw,16px);
      appearance:auto;
    }
    .search-input{ min-width:min(42vw, 320px); }

    .link-btn{
      background:rgba(255,255,255,.08);
      color:var(--text);
      border:1px solid rgba(255,255,255,.25);
      border-radius:12px;
      padding:10px 14px;
      text-decoration:none;
      font-weight:700; font-size:clamp(14px,1.6vw,16px);
      white-space:nowrap;
      min-height:var(--tap-min);
    }

    /* MAIN / Swiper */
    main{ flex:1 1 auto; min-height:0 !important; display:block; overflow:hidden; }
    .carousel { position:relative; height:100%; min-height:0 !important; }
    .swiper, .swiper-wrapper, .swiper-slide { height:100% !important; min-height:0 !important; }
    .swiper { width:100%; position:relative; z-index:1; overflow:hidden; }

    .swiper-slide{ display:flex; flex-direction:column; align-items:stretch; padding:0 0 22px 0; }
    .viewer{ flex:1 1 auto; min-height:0 !important; display:block; }
    .swiper-zoom-container{ width:100%; height:100%; min-height:0 !important; }
    .swiper-zoom-container img{ width:100%; height:100%; object-fit:contain; background:rgba(0,0,0,.25); display:block; touch-action:pan-x pan-y; }

    /* PDFs */
    .pdf-card{ display:grid; place-items:center; width:100%; height:100%; background:rgba(0,0,0,.25); border-radius:8px; }
    .pdf-title{ margin-top:8px; font-size:14px; color:var(--muted) }

    /* Caption */
    .caption{ flex:0 0 auto; display:flex; justify-content:space-between; align-items:center; gap:12px; padding:10px clamp(10px,2vw,14px); }
    .caption h3{ margin:0; color:var(--text); font-size:clamp(16px, 2vw, 20px); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:72vw; }

    /* Swiper buttons */
    .swiper-button-prev, .swiper-button-next{
      width:48px; height:48px; border-radius:999px;
      background:rgba(0,0,0,.45);
      border:1px solid rgba(255,255,255,.35);
      color:#fff; backdrop-filter:blur(2px);
      z-index:50 !important; pointer-events:auto !important;
    }
    .swiper-button-prev::after, .swiper-button-next::after{ font-size:20px; font-weight:700 }
    .swiper-button-prev{ left:12px } .swiper-button-next{ right:12px }
    .swiper .swiper-pagination{ bottom:6px !important; }

    .swiper-pagination-bullet{ background:rgba(255,255,255,.35); opacity:1; border:1px solid rgba(255,255,255,.45) }
    .swiper-pagination-bullet-active{ background:var(--accent); border-color:transparent }

    /* FOOTER */
    .return-note{
      flex:0 0 auto; margin:0; padding:8px clamp(10px,2vw,14px);
      font-size:13px; color:var(--muted);
      background:rgba(0,0,0,.25); border-top:1px solid rgba(255,255,255,.06);
      display:flex; gap:8px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    }

    .toast{ position:fixed; inset:auto 16px 16px auto; background:rgba(0,0,0,.6); color:white; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.12); font-size:13px; display:none; z-index:10000; }
    .toast.show{ display:block }

    @media (max-width: 680px){
      header.header{ grid-template-columns:1fr; justify-items:stretch }
      .hdr-left, .hdr-center, .hdr-right{ justify-self:stretch }
      .hdr-center{ justify-content:space-between }
      .caption h3{ max-width:60vw }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- HEADER -->
    <header class="header">
      <div class="hdr-left"><h1>üìã Cartells i protocols</h1></div>

      <div class="hdr-center">
        <label for="serviceSelect" class="sr-only">Filtra per servei</label>
        <select id="serviceSelect" class="service-select" aria-label="Filtra per servei">
          <option value="tots">Tots els serveis</option>
          <option value="hospitalitzacio">Hospitalitzaci√≥</option>
          <option value="urgencies">Urg√®ncies</option>
          <option value="area-quirurgica">√Ärea Quir√∫rgica</option>
          <option value="consultes-externes">Consultes Externes</option>
        </select>

        <label for="typeSelect" class="sr-only">Filtra per tipus</label>
        <select id="typeSelect" class="type-select" aria-label="Filtra per tipus">
          <option value="tots">Tots els tipus</option>
          <option value="cartell">Cartells</option>
          <option value="protocol">Protocols</option>
        </select>

        <!-- üîç Nou: buscador de text -->
        <label for="textSearch" class="sr-only">Cerca per paraula clau</label>
        <input id="textSearch" class="search-input" type="search" placeholder="üîç Cerca t√≠tol, servei o etiquetes‚Ä¶" aria-label="Cerca per paraula clau">
      </div>

      <div class="hdr-right">
        <a class="link-btn" href="index.html" id="backBtn" title="Torna al monitor" rel="noopener noreferrer">‚Üê Torna al monitor</a>
      </div>
    </header>

    <!-- MAIN / CARRUSEL -->
    <main>
      <div class="carousel" aria-roledescription="carrusel" aria-label="Cartells disponibles">
        <div class="swiper" id="swiper">
          <div class="swiper-wrapper" id="swiperWrapper"></div>
          <div class="swiper-button-prev" id="btnPrev" aria-label="Anterior"></div>
          <div class="swiper-button-next" id="btnNext" aria-label="Seg√ºent"></div>
          <div class="swiper-pagination" id="dots" aria-hidden="true"></div>
        </div>
      </div>
    </main>

    <!-- FOOTER -->
    <div class="return-note">
      <span>Despla√ßa a esquerra/dreta, usa les fletxes del teclat o els botons.</span>
      <span id="cdWrap">Tornada autom√†tica al monitor en <strong class="countdown" id="countdown">05:00</strong>.</span>
    </div>

    <div class="toast" id="toast">Tornant al monitor‚Ä¶</div>
  </div>

  <!-- Supabase + Swiper -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/swiper@11/swiper-bundle.min.js"></script>

  <script>
  // ================================
  // Config Supabase
  // ================================
  const SUPABASE_URL = "https://wnkgzpgagprncbtqnzrw.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indua2d6cGdhZ3BybmNidHFuenJ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNjQyNTQsImV4cCI6MjA3MDc0MDI1NH0.sXkV7N9Y2nDOTA3tZpWkAhs2SCGriXJWyieglxxFIRY";
  const supabase = (SUPABASE_URL && SUPABASE_ANON_KEY) ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : null;

  // client global per altres scripts (logger, etc.)
  if (supabase && !window.supabaseClient) window.supabaseClient = supabase;

  // Mapes: valor del select ‚Üí etiqueta humana
  const SERVICE_LABEL = {
    'hospitalitzacio': 'Hospitalitzaci√≥',
    'urgencies': 'Urg√®ncies',
    'area-quirurgica': '√Ärea Quir√∫rgica',
    'consultes-externes': 'Consultes Externes'
  };

  // ---------- Elements ----------
  const wrapper       = document.getElementById('swiperWrapper');
  const btnPrevEl     = document.getElementById('btnPrev');
  const btnNextEl     = document.getElementById('btnNext');
  const dotsEl        = document.getElementById('dots');
  const toastEl       = document.getElementById('toast');
  const COUNTDOWN_EL  = document.getElementById('countdown');
  const serviceSelect = document.getElementById('serviceSelect');
  const typeSelect    = document.getElementById('typeSelect');
  const textSearch    = document.getElementById('textSearch');

  // ---------- Swiper ----------
  let swiper = null;
  let currentDocs = [];

  function initSwiper(slideCount){
    if (swiper) { try { swiper.destroy(true, true); } catch {} swiper = null; }
    btnPrevEl.style.display = '';
    btnNextEl.style.display = '';
    dotsEl.style.display    = (slideCount > 1) ? '' : 'none';

    swiper = new Swiper('#swiper', {
      loop: (slideCount > 1),
      allowTouchMove: true,
      speed: 350,
      centeredSlides: true,
      slidesPerView: 1,
      keyboard: { enabled: true },
      navigation: { nextEl: '#btnNext', prevEl: '#btnPrev' },
      pagination: (slideCount > 1) ? { el: '#dots', clickable: true } : { el: '#dots', clickable: false },
      zoom: { enabled: true, maxRatio: 3 },
      on: {
        slideChange: () => {
          resetIdle();
          if (swiper && currentDocs[swiper.activeIndex]) {
            tryLogSeen(currentDocs[swiper.activeIndex]);
          }
        },
        touchStart: resetIdle
      }
    });
  }

  // Delegaci√≥: quan alg√∫ clica ‚ÄúObrir‚Äù, tamb√© registrem
  wrapper.addEventListener('click', (ev) => {
    const a = ev.target.closest('.actions a');
    if (!a) return;
    const idx = swiper?.activeIndex ?? 0;
    if (currentDocs[idx]) tryLogSeen(currentDocs[idx]);
  });

  // Pinta cada slide (usa thumb si existeix)
  function makeSlide(model){
    // model: { kind: 'img'|'pdf', url, thumb|null, title, mime }
    const slide = document.createElement('div');
    slide.className = 'swiper-slide';

    const viewer = document.createElement('div');
    viewer.className = 'viewer';

    const displayUrl = model.thumb || (model.kind === 'img' ? model.url : null);
    if (displayUrl){
      const zoom = document.createElement('div');
      zoom.className = 'swiper-zoom-container';
      const img = document.createElement('img');
      img.alt = model.title || '';
      img.src = displayUrl;
      zoom.appendChild(img);
      viewer.appendChild(zoom);
    } else {
      const box = document.createElement('div');
      box.className = 'pdf-card';
      box.innerHTML = `<div style="font-size:42px">üìÑ</div><div class="pdf-title">${model.title || 'Document'}</div>`;
      viewer.appendChild(box);
    }

    const cap = document.createElement('div');
    cap.className = 'caption';
    cap.innerHTML = `<h3 title="${model.title || ''}">${model.title || ''}</h3>
                     <div class="actions"><a class="link-btn" href="${model.url}" target="_blank" rel="noopener noreferrer">Obrir</a></div>`;

    slide.appendChild(viewer);
    slide.appendChild(cap);
    return slide;
  }

  function cleanupObjectURLs(){
    wrapper.querySelectorAll('img').forEach(img=>{
      if (img.src.startsWith('blob:')) { try { URL.revokeObjectURL(img.src); } catch {} }
    });
    wrapper.querySelectorAll('.actions a').forEach(a=>{
      if (a.href.startsWith('blob:')) { try { URL.revokeObjectURL(a.href); } catch {} }
    });
  }
  window.addEventListener('beforeunload', cleanupObjectURLs);

  // ---------- Consulta a Supabase (filtrada en servidor) ----------
  async function fetchFromSupabase(svcCode, kindCode){
    if (!supabase) return [];
    let q = supabase
      .from('documents')
      .select(`
        id, title, service, kind, languages,
        mime, file_url, thumb_url,
        published, order_index, updated_at
      `)
      .eq('published', true);

    if (svcCode !== 'tots') {
      const human = SERVICE_LABEL[svcCode] || svcCode;
      q = q.or(`service.ilike.%${human}%,service.ilike.%${svcCode}%`);
    }

    if (kindCode !== 'tots') {
      q = q.eq('kind', kindCode);
    }

    q = q.order('order_index', { ascending: true, nullsFirst: true })
         .order('updated_at', { ascending: false });

    const { data, error } = await q;
    if (error){ console.error('[Supabase] error:', error); return []; }

    // Conserva metadata per analytics
    return (data || []).map(row => {
      const fromMime = (row.mime || '').startsWith('image/') ? 'img'
                      : (row.mime === 'application/pdf') ? 'pdf'
                      : 'img';
      const kind = row.kind ? (row.kind === 'cartell' ? 'img' : 'pdf') : fromMime;

      return {
        id: row.id,
        title: row.title || 'Document',
        service: row.service || null,
        kind,                     // 'img'|'pdf' per pintar
        rawKind: row.kind || null, // valor original guardat ('cartell'|'protocol')
        languages: row.languages || null,
        mime: row.mime || '',
        url: row.file_url,
        thumb: row.thumb_url || null
      };
    });
  }

  // ---------- Cerca client-side ----------
  function norm(v){ return String(v||'').toLowerCase(); }

  function passSearchFilter(item, term){
    if (!term) return true;
    const t = norm(term);
    const inTitle   = norm(item.title).includes(t);
    const inService = norm(item.service).includes(t);
    const langs     = Array.isArray(item.languages) ? item.languages.join(',') : (item.languages || '');
    const inLangs   = norm(langs).includes(t);
    // Si alg√∫n d√≠a tienes tags, se puede a√±adir aqu√≠:
    // const inTags = norm((item.tags||[]).join(',')).includes(t);
    return inTitle || inService || inLangs;
  }

  // ---------- Construcci√≥ UI ----------
  async function buildSlides(){
    cleanupObjectURLs();
    wrapper.innerHTML = '';

    const svc  = serviceSelect.value;
    const kind = typeSelect.value;
    const term = (textSearch.value || '').trim();

    let slides = await fetchFromSupabase(svc, kind);

    // Heur√≠stica extra per MIME si el filtre de tipus est√† actiu
    if (kind !== 'tots') {
      slides = slides.filter(s => {
        if (kind === 'cartell')  return s.kind === 'img' || (s.mime || '').startsWith('image/');
        if (kind === 'protocol') return s.kind === 'pdf' || s.mime === 'application/pdf';
        return true;
      });
    }

    // üîç Filtre de text (t√≠tol, servei, idiomes/etiquetes)
    if (term) {
      slides = slides.filter(s => passSearchFilter(s, term));
    }

    if (!slides.length){
      const slide = document.createElement('div');
      slide.className = 'swiper-slide';
      const empty = document.createElement('div');
      empty.className = 'pdf-card';
      const svcLabel  = (svc==='tots' ? 'Tots els serveis' : (SERVICE_LABEL[svc]||'Servei'));
      const kindLabel = (kind==='tots' ? 'tots els tipus' : (kind==='protocol' ? 'protocols' : 'cartells'));
      empty.innerHTML = `<div>Cap element per a ‚Äú${svcLabel} ¬∑ ${kindLabel}${term ? ' ¬∑ ' + term : ''}‚Äù.</div>`;
      slide.appendChild(empty);
      wrapper.appendChild(slide);
      currentDocs = [];
      initSwiper(1);
      return;
    }

    slides.forEach(s => wrapper.appendChild(makeSlide(s)));
    currentDocs = slides.slice();
    initSwiper(slides.length);

    // Log de la diapositiva inicial (si existeix)
    if (swiper && currentDocs[swiper.activeIndex]) {
      tryLogSeen(currentDocs[swiper.activeIndex]);
    }
  }

  // ---------- Auto-retorn ----------
  const IDLE_MS = 5*60*1000;
  let idleTimer = null, tickTimer = null, deadline = Date.now() + IDLE_MS;

  function fmt(ms){ const s=Math.max(0,Math.round(ms/1000)); const m=String(Math.floor(s/60)).padStart(2,'0'); const r=String(s%60).padStart(2,'0'); return `${m}:${r}`; }
  function updateCountdown(){
    const left = deadline - Date.now();
    COUNTDOWN_EL.textContent = fmt(left);
    if (left <= 10_000) toastEl.classList.add('show'); else toastEl.classList.remove('show');
    if (left <= 0) goBack();
  }
  function startIdle(){ stopIdle(); deadline = Date.now() + IDLE_MS; idleTimer=setTimeout(goBack,IDLE_MS); tickTimer=setInterval(updateCountdown,1000); updateCountdown(); }
  function stopIdle(){ if (idleTimer){clearTimeout(idleTimer); idleTimer=null;} if (tickTimer){clearInterval(tickTimer); tickTimer=null;} }
  function resetIdle(){ startIdle(); }
  function goBack(){ stopIdle(); document.body.classList.add('fading'); setTimeout(()=>{ location.href='index.html'; }, 250); }

  // ---------- Persist√®ncia filtres ----------
  const savedSvc     = localStorage.getItem('cartells.service') || 'tots';
  const savedKind    = localStorage.getItem('cartells.kind')    || 'tots';
  const savedSearch  = localStorage.getItem('cartells.search')  || '';
  serviceSelect.value = savedSvc;
  typeSelect.value    = savedKind;
  textSearch.value    = savedSearch;

  ['pointerdown','pointermove','wheel','keydown','touchstart'].forEach(ev =>
    document.addEventListener(ev, resetIdle, { passive:true })
  );
  document.getElementById('backBtn').addEventListener('click', (e)=>{ e.preventDefault(); goBack(); });

  serviceSelect.addEventListener('change', ()=>{
    localStorage.setItem('cartells.service', serviceSelect.value);
    buildSlides(); resetIdle();
  });
  typeSelect.addEventListener('change', ()=>{
    localStorage.setItem('cartells.kind', typeSelect.value);
    buildSlides(); resetIdle();
  });
  textSearch.addEventListener('input', ()=>{
    localStorage.setItem('cartells.search', textSearch.value);
    buildSlides(); resetIdle();
  });

  // ---------- Init ----------
  window.addEventListener('load', async ()=>{
    document.body.classList.add('ready');
    await buildSlides();
    startIdle();
  });

  // SW opcional
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./service-worker.js').catch(()=>{});
    });
  }
  </script>

  <script>
    // Marca body per a regles espec√≠fiques si cal
    if (document.querySelector('.carousel')) document.body.classList.add('carteles');
  </script>

  <!-- Logger d‚Äô√∫s (si el tens) -->
  <script>
    // tryLogSeen tolerant a entorn
    function getSupabaseForLogs(){
      if (window.supabaseClient) return window.supabaseClient;
      if (typeof window.supabase !== 'undefined' && window.supabase.createClient) {
        return window.supabase.createClient(
          "https://wnkgzpgagprncbtqnzrw.supabase.co",
          "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indua2d6cGdhZ3BybmNidHFuenJ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNjQyNTQsImV4cCI6MjA3MDc0MDI1NH0.sXkV7N9Y2nDOTA3tZpWkAhs2SCGriXJWyieglxxFIRY"
        );
      }
      return null;
    }

    const tryLogSeen = (() => {
      const last = new Map();      // doc_id -> ts
      const MIN_GAP = 60 * 1000;   // 60s

      return async function(doc){
        try{
          if (!doc || !doc.id) return;

          const now = Date.now();
          const prev = last.get(doc.id) || 0;
          if (now - prev < MIN_GAP) return; // desdup 60s
          last.set(doc.id, now);

          const client = getSupabaseForLogs();
          if (!client) return;

          const kindForLog =
            doc.rawKind ||
            (doc.mime === 'application/pdf' ? 'protocol' : 'cartell');

          const lang =
            (Array.isArray(doc.languages) ? doc.languages[0] : doc.languages) ||
            (navigator.language || null);

          // ‚ö†Ô∏è Assegura que les columnes existeixen a la teva view_logs
          await client.from('view_logs').insert({
            doc_id: doc.id,
            service: doc.service || null,
            kind: kindForLog,
            // elimina/afegeix camps segons el teu esquema:
            // lang: lang || null,
            // path: location.pathname,
            user_agent: navigator.userAgent.slice(0, 512)
          });
        } catch(e){
          // opcional: console.warn('[view_logs] insert failed:', e);
        }
      };
    })();
  </script>
</body>
</html>